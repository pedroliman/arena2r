#' Get Results from Arena CSV Files
#' Get Results from Arena CSV Files
#'
#' This function reads all csv files inside the provided path and returns a data.frame with the simulation runs, consolidated.
#' You should provide a path containing only csv files generated by Arena, with the same number of replications. I Suggest you to name your csv files after your scenarios.
#'
#' @param path The path where csv files is stored. If you do not provide a value, I'll assume they're on your current working directory.
#'
#' @return a tidy dataframe with simulation results.
#' @export
#'
get_simulation_results = function(path) {

  if (missing(path)) {
    path = getwd()
  }

  caminho_arquivos = paste(path, list.files(path = path,pattern = ".csv"), sep = "/")
  nomes_cenarios <- list.files(path = path,pattern = ".csv")
  nomes_cenarios = gsub(".csv", "", nomes_cenarios)

  for (i in 1:length(nomes_cenarios)) {

    dados_cenario = read.csv(file = caminho_arquivos[i])

    dados_cenario$Scenario = nomes_cenarios[i]

    if(i == 1) {
      dados_completos = dados_cenario
    } else {
      dados_completos = rbind(dados_completos, dados_cenario)
    }

  }

  # Definindo Cenario como um Fator:
  dados_completos$Scenario = as.factor(dados_completos$Scenario)

  # Trazendo coluna dos Cenarios para a Frente:

  dados_completos = dados_completos[,c(length(names(dados_completos)), 1:(length(names(dados_completos))-1))]

  # Empilhando os Dados para Facilitar as Coisas

  dados_empilhados = dados_completos %>% tidyr::gather(key = Replication, value = Value, 7:length(names(dados_completos)))

  dados_finais = dados_empilhados %>%
    dplyr::select(Scenario, Statistic.Name, Replication, Value) %>%
    dplyr::arrange(Scenario, Statistic.Name, Replication) %>%
    dplyr::mutate(Replication = as.numeric(sub(x = Replication, pattern = "Rep.", replacement = "")))
  names(dados_finais) = c("Scenario", "Statistic", "Replication", "Value")

  dados_finais

}


#### Plots

#' Confidence Interval Plot
#'
#' Plots the confidence interval for a response variable, across different simulated scenarios.
#'
#' @param sim_results The data.frame generated by get_simulation_results()
#' @param response_variable A character string indicating the Statistic to be plotted.
#'
#' @return a confidence interval plot using ggplot2.
#' @export
#'
confint_plot = function(sim_results, response_variable) {

  sim_results = sim_results %>%
    tidyr::spread(Statistic, Value)

  plot_call = substitute(
    expr = ggplot(sim_results, aes(x = Scenario, y = ResponseVariable, color = Scenario)),
    env = list(ResponseVariable = as.name(response_variable))
  )

  p =  eval(plot_call)

  p + geom_jitter(height = 0, width = 0.1, alpha = 0.2) +
    stat_summary(fun.data = mean_cl_normal, geom = "errorbar", mult = 1, lwd = 1) +
    stat_summary(fun.y = mean,geom="point",lwd=2, group=1) +
    theme(legend.position="none")

}

#' Get Statics Summary
#'
#' Makes a summary table to every statistic available
#'
#' @param sim_results The data.frame generated by get_simulation_results()
#'
#' @return a data.frame with a summary for every Statistic
#' @export
#'
get_statistics_summary = function(sim_results, confidence = 0.95) {

  sim_results %>%
    dplyr::group_by(Scenario, Statistic) %>%
    dplyr::summarise(Mean = gmodels::ci(Value, confidence = confidence)[1],
                     Median = median(Value, confidence = confidence),
                     LowerLimit = gmodels::ci(Value, confidence = confidence)[2],
                     UpperLimit = gmodels::ci(Value, confidence = confidence)[3],
                     StandardDev = gmodels::ci (Value, confidence = confidence)[4],
                     Min = min(Value),
                     Max = max(Value)) %>%
    dplyr::mutate(CV = StandardDev / Mean)

}


